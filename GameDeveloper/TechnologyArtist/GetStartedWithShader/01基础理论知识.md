# 基础理论知识

## 概括

渲染的基本要素包括：
- **模型（Model）**：物体的几何信息，描述了三维对象的形状。
- **材质（Material）**：描述物体的表面属性，例如颜色、光泽、纹理等。
- **Shader**：负责计算如何渲染物体，将材质信息和光照计算结合。

为了提升渲染效率，实现并行化计算，CPU 和 GPU 需要协同工作，渲染管线分为以下几个主要层级：
- **应用层**：CPU 侧的应用代码将渲染数据转化为 Draw Call 并发给驱动层。
- **驱动层**：将 Draw Call 填充到命令缓冲区（Command Buffer）中。
- **GPU层**：GPU 从命令缓冲区读取命令，执行渲染流水线中的各个阶段。

### 应用层

在应用层，主要处理以下任务：
- **数据加载**：将需要的模型、材质、纹理等数据加载到 GPU 的显存中。
- **设置渲染状态**：包括选择使用的 Shader、光照参数、纹理采样方式等。
- **生成 Draw Call**：告诉 GPU 使用哪些资源、如何进行渲染，将所有这些指令发送到驱动层。

### GPU 渲染流水线

当 GPU 接收到 Draw Call 后，进入渲染流水线进行处理。渲染流水线主要分为两个阶段：
1. **几何阶段（Geometry Stage）**
   - 处理顶点相关的计算。
   - 完全可编程。
2. **光栅化阶段（Rasterization Stage）**
   - 将几何数据转换为屏幕上的像素数据。
   - 包括三角形遍历、片元着色等。

## 几何阶段

### 顶点着色器（Vertex Shader）
顶点着色器逐顶点执行，负责所有与顶点相关的计算。其主要任务包括：
- **顶点位移**：例如模拟旗帜的飘动，或生成背面描边效果。
- **传递数据**：计算并传递给后续阶段的数据，例如世界坐标、逐顶点光照等。
- **坐标变换**：将顶点从模型空间转换到齐次裁剪空间，这是渲染流水线中的核心工作之一。

### 裁剪（Clipping）
裁剪阶段负责处理图元与视野范围的关系。它将视锥体之外的顶点或图元裁剪掉，确保只有视野范围内的对象会被进一步处理，优化渲染性能。

[你可以参考 TA 的网站获取更多渲染流水线的可视化资料](https://simonschreibt.de/)。

### 屏幕映射（Screen Mapping）
屏幕映射将三维坐标转换为二维屏幕坐标，最终为后续的光栅化阶段做准备。这个步骤将顶点从齐次裁剪空间映射到屏幕空间。

## 光栅化阶段

### 三角形设置（Triangle Setup）
在三角形设置阶段，计算三角形的边界，并为后续的三角形遍历做准备。三角形的顶点信息和屏幕坐标在这个阶段得到确定。

### 三角形遍历（Triangle Traversal）
在三角形遍历过程中，系统会检查三角形是否位于当前屏幕区域内。如果是，则进一步处理：
- **Culling（背面剔除）**：剔除面向摄像机背面的三角形，以减少不必要的计算。
- **插值计算**：计算三角形内部片元的插值，生成片元属性（如颜色、纹理坐标等）。

### 片元着色器（Fragment Shader）
片元着色器（或称为像素着色器）负责逐片元计算物体的最终颜色。其主要任务包括：
- **纹理采样**：读取纹理信息并将其应用到片元上。
- **光照计算**：根据光源和材质属性，计算片元的光照结果，决定其最终颜色。

### 逐片元操作（Per-Fragment Operations）
在片元着色器之后，进入逐片元操作阶段。此阶段决定片元如何输出到帧缓冲区：
- **可见性测试**：例如深度测试（Depth Test）和模板测试（Stencil Test），判断片元是否可见。
- **颜色混合**：混合片元的颜色与已经存在于缓冲区中的颜色。特别是在处理透明物体时，混合操作非常重要。

---

通过这几个阶段的处理，GPU 渲染流水线能够将三维物体最终转换为屏幕上的像素显示。理解这些基础理论和渲染流程有助于在实际的图形编程中优化渲染效果。